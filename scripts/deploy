#!/bin/bash

# TODO: set fail on error

build(){
  rm -f dist/index.js dist/muzak.js dist/muzak.zip

  # # Zip everything including node_modules
  # zip -rq dist/muzak.zip index.js config.js node_modules -x node_modules/{aws-lambda-mock-content,chai,eslint,mocha,prettier,webpack}

  webpack
  (
    cd dist
    zip muzak.zip index.js
  )
}

deploy(){
  AWS_DEFAULT_PROFILE=personal
  AWS_ENV="Variables=\"{$( perl -e'print join ",", map { chomp; $_ } <>' < .env )}\""
  AWS_ENV="$( perl -MJSON=encode_json -E'while(<>){ chomp; my ($k,$v) = split /=/, $_, 2; $h->{$k}=$v }; print encode_json { Variables => $h }' < .env )"
  echo $AWS_ENV
  aws --region us-east-1 lambda update-function-configuration \
      --function-name AlexaLMSInterface \
      --environment "$AWS_ENV"
  aws --region us-east-1 lambda update-function-code \
      --function-name AlexaLMSInterface --zip-file fileb://dist/muzak.zip
}

build && deploy
# build
# deploy
